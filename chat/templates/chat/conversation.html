{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Conversation{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static "styles/navbar.css" %}">
    <link rel="stylesheet" href="{% static "styles/footer.css" %}">
    <link rel="stylesheet" href="{% static 'styles/chat/conversation.css' %}">
    <link rel="stylesheet" href="{% static "styles/chat/home.css" %}">
{% endblock %}

{% block content %}
    {% include 'navbar.html' %}
    {% include 'chat/modal.html' %}
    <div class="chat-container">
        <div class="display-chats">
            {% include "chat/chat-header.html" %}
            {% include "chat/chats.html" %}
        </div>

        <div class="messaging-space">
            <div class="friend-header">
                {% with chat.members.all as members %}
                    {% if members.0 == user %}
                        {% with members.1 as other_user %}
                            {% if other_user.image %}
                                <img src="{{ other_user.image.crop.70x70 }}"
                                     class="friends-profile-picture"
                                     alt="{{ other_user.username }}">
                            {% else %}
                                <img class="friends-profile-picture"
                                     src="{% static 'images/profile_default.png' %}"
                                     alt="{{ other_user.username }}">
                            {% endif %}
                            <div class="friend-name-conv">{{ other_user }}</div>
                            <div class="circle-inactive" id="circle_{{ other_user.username }}"></div>
                        {% endwith %}
                    {% else %}
                        {% with members.0 as other_user %}
                            {% if other_user.image %}
                                <img src="{{ other_user.image.crop.70x70 }}"
                                     class="friends-profile-picture"
                                     alt="{{ other_user.username }}">
                            {% else %}
                                <img class="friends-profile-picture"
                                     src="{% static 'images/profile_default.png' %}"
                                     alt="{{ other_user.username }}">
                            {% endif %}
                            <div class="friend-name-conv">{{ other_user }}</div>
                            <div class="circle-inactive" id="circle_{{ other_user.username }}"></div>
                        {% endwith %}
                    {% endif %}

                {% endwith %}
            </div>
            <div id="chat-log">
                {% for message in messages.all %}
                    {% if message.author == request.user %}
                        <div class="chat-message my-message">
                            <strong class="username">{{ message.author.username }}</strong>
                            <div class="message-container">
                                {{ message.text }}
                                {% if message.file %}
                                    {% with message.file.name|lower|get_extension as file_extension %}
                                        {% if file_extension in image_formats %}
                                            <img class="message-file" src="{{ message.file.url }}" alt="photo">
                                        {% else %}
                                            <div>
                                                <a href="{{ message.file.url }}" class="message-file">ðŸ”— Download</a>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                                <span class="timestamp">({{ message.created_at|date:"SHORT_DATETIME_FORMAT" }})</span>
                            </div>
                        </div>
                    {% else %}
                        <div class="chat-message">
                            <strong class="username">{{ message.author.username }}</strong>
                            <div class="message-container">
                                {{ message.text }}
                                {% if message.file %}
                                    {% with message.file.name|lower|get_extension as file_extension %}
                                        {% if file_extension in image_formats %}
                                            <img class="message-file" src="{{ message.file.url }}" alt="photo">
                                        {% else %}
                                            <a class="message-file" href="{{ message.file.url }}">ðŸ”— Download</a>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                                <span class="timestamp">({{ message.created_at|date:"SHORT_DATETIME_FORMAT" }})</span>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <div class="align-right">
                <div class="file-uploading-container">
                    <label for="file-upload" class="file-upload">
                        <img class="upload-file-icon" src="{% static "images/file-upload.png" %}">
                    </label>
                    <input type="file" id="file-upload">
                    <div id="file-upload-status" class="file-upload-status"></div>
                </div>
                <div class="typing-container">
                    <textarea id="chat-message-input" type="text"
                              placeholder="Type your message here..."></textarea><br>
                    <input id="chat-message-submit" type="submit" value="Send">
                </div>
                {{ conversation|json_script:"conversation" }}
            </div>
        </div>
    </div>

{% endblock %}

{% block script %}
    <script>
        window.chatConfig = {
            currentUserUsername: "{{ request.user.username }}",
        };
    </script>
    <script src="{% static 'js/chat.js' %}"></script>
    <script src="{% static 'js/modal.js' %}"></script>
    <script src="{% static "js/notifications.js" %}"></script>

{% endblock %}